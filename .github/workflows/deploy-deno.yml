name: Deploy to Deno Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Deno Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for DENO_DEPLOY_TOKEN
        run: |
          if [ -z "${{ secrets.DENO_DEPLOY_TOKEN }}" ]; then
            echo "❌ DENO_DEPLOY_TOKEN not set"
            echo "Add it to GitHub Secrets to enable deployment"
            exit 1
          fi
          echo "✅ DENO_DEPLOY_TOKEN found"

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Type check
        run: |
          deno check server.ts
          deno check memo-service.ts

      - name: Deploy to Deno Deploy
        run: |
          deno install --allow-all --no-check https://deno.land/x/deployctl@1.19.0/deployctl.ts
          deployctl deploy --project=agent-memo --token=${{ secrets.DENO_DEPLOY_TOKEN }} server.ts